(function(){"use strict";const g=[0,0,1,-1],T=[1,-1,0,0];function C(e){return e.map(s=>s.slice())}function Y(e){return 3-e}function m(e,s){return e>=0&&e<13&&s>=0&&s<13}function $(e,s,n){const r=e[s][n];if(r===0)return{stones:[],liberties:new Set};const t=new Set,o=[],l=new Set,u=[[s,n]];for(;u.length>0;){const[f,i]=u.pop(),a=`${f},${i}`;if(!t.has(a)){t.add(a),o.push([f,i]);for(let N=0;N<4;N++){const h=f+g[N],c=i+T[N];m(h,c)&&(e[h][c]===0?l.add(`${h},${c}`):e[h][c]===r&&!t.has(`${h},${c}`)&&u.push([h,c]))}}}return{stones:o,liberties:l}}function I(e,s,n,r){if(!m(s,n)||e[s][n]!==0)return{captured:[],valid:!1};e[s][n]=r;const t=Y(r),o=[];for(let u=0;u<4;u++){const f=s+g[u],i=n+T[u];if(m(f,i)&&e[f][i]===t){const a=$(e,f,i);if(a.liberties.size===0)for(const[N,h]of a.stones)e[N][h]=0,o.push([N,h])}}if($(e,s,n).liberties.size===0){e[s][n]=0;for(const[u,f]of o)e[u][f]=t;return{captured:[],valid:!1}}return{captured:o,valid:!0}}function k(e){let s="";for(let n=0;n<13;n++)for(let r=0;r<13;r++)s+=e[n][r];return s}function H(e,s,n){const r=[];for(let t=0;t<13;t++)for(let o=0;o<13;o++){if(e[t][o]!==0)continue;const l=C(e);I(l,t,o,s).valid&&(n&&k(l)===n||r.push([t,o]))}return r}function L(e){const s=Array.from({length:13},()=>new Array(13).fill(!1));let n=0,r=0;for(let t=0;t<13;t++)for(let o=0;o<13;o++)e[t][o]===1?n++:e[t][o]===2&&r++;for(let t=0;t<13;t++)for(let o=0;o<13;o++){if(e[t][o]!==0||s[t][o])continue;const l=[];let u=!1,f=!1;const i=[[t,o]];for(;i.length>0;){const[a,N]=i.pop();if(!s[a][N]){s[a][N]=!0,l.push([a,N]);for(let h=0;h<4;h++){const c=a+g[h],p=N+T[h];m(c,p)&&(e[c][p]===1?u=!0:e[c][p]===2?f=!0:s[c][p]||i.push([c,p]))}}}u&&!f?n+=l.length:f&&!u&&(r+=l.length)}return{black:n,white:r+6.5}}function S(e,s){const n=e[s],r=new Uint8Array(169),t=[s];for(;t.length>0;){const o=t.pop();if(r[o])continue;r[o]=1;const l=o/13|0,u=o%13;for(let f=0;f<4;f++){const i=l+g[f],a=u+T[f];if(i>=0&&i<13&&a>=0&&a<13){const N=i*13+a;if(e[N]===0)return!0;e[N]===n&&!r[N]&&t.push(N)}}}return!1}function D(e,s){const n=e[s],r=new Uint8Array(169),t=[s];let o=0;for(;t.length>0;){const l=t.pop();if(r[l])continue;r[l]=1,e[l]=0,o++;const u=l/13|0,f=l%13;for(let i=0;i<4;i++){const a=u+g[i],N=f+T[i];if(a>=0&&a<13&&N>=0&&N<13){const h=a*13+N;e[h]===n&&!r[h]&&t.push(h)}}}return o}function b(e){const s=new Uint8Array(169);let n=0,r=0;for(let t=0;t<169;t++)e[t]===1?n++:e[t]===2&&r++;for(let t=0;t<169;t++){if(e[t]!==0||s[t])continue;let o=0,l=!1,u=!1;const f=[t];for(;f.length>0;){const i=f.pop();if(s[i])continue;s[i]=1,o++;const a=i/13|0,N=i%13;for(let h=0;h<4;h++){const c=a+g[h],p=N+T[h];if(c>=0&&c<13&&p>=0&&p<13){const w=c*13+p;e[w]===1?l=!0:e[w]===2?u=!0:s[w]||f.push(w)}}}l&&!u?n+=o:u&&!l&&(r+=o)}return n>r+6.5}function F(e,s){const n=new Int8Array(169);for(let u=0;u<13;u++)for(let f=0;f<13;f++)n[u*13+f]=e[u][f];let r=s,t=0,o=0;const l=[];for(;t<2&&o<250;){l.length=0;for(let i=0;i<169;i++)n[i]===0&&l.push(i);if(l.length===0){t++,r=3-r,o++;continue}let u=!1;const f=3-r;for(let i=l.length-1;i>=0;i--){const a=Math.floor(Math.random()*(i+1)),N=l[i];l[i]=l[a],l[a]=N;const h=l[i],c=h/13|0,p=h%13;let w=!0;for(let d=0;d<4;d++){const v=c+g[d],M=p+T[d];if(v>=0&&v<13&&M>=0&&M<13&&n[v*13+M]!==r){w=!1;break}}if(w)continue;n[h]=r;let E=0;for(let d=0;d<4;d++){const v=c+g[d],M=p+T[d];v>=0&&v<13&&M>=0&&M<13&&n[v*13+M]===f&&(S(n,v*13+M)||(E+=D(n,v*13+M)))}if(E===0&&!S(n,h)){n[h]=0;continue}u=!0,t=0;break}u||t++,r=3-r,o++}return b(n)?1:0}class W{constructor(s,n,r,t){this.children=[],this.visits=0,this.wins=0,this.move=s,this.color=n,this.parent=r,this.untriedMoves=t}ucb1(s){return this.visits===0?1/0:this.wins/this.visits+s*Math.sqrt(Math.log(this.parent.visits)/this.visits)}bestChild(s){let n=this.children[0],r=-1/0;for(const t of this.children){const o=t.ucb1(s);o>r&&(r=o,n=t)}return n}}function O(e,s,n,r){let t=0;for(let c=0;c<13;c++)for(let p=0;p<13;p++)e[c][p]!==0&&t++;if(t===0)return[6,6];if(t===1){const c=[[3,3],[3,9],[9,3],[9,9],[6,6]];for(const p of c)if(e[p[0]][p[1]]===0)return p}const o=H(e,s,n);if(o.length===0)return null;if(o.length===1)return o[0];const l=new W(null,Y(s),null,[...o]),u=Date.now();let f=0;for(;!(f>0&&f%5===0&&Date.now()-u>=r);){let c=l;const p=C(e);let w=s,E=n;for(;c.untriedMoves.length===0&&c.children.length>0;)if(c=c.bestChild(1.41),c.move){const M=k(p);I(p,c.move[0],c.move[1],w),E=M,w=Y(w)}if(c.untriedMoves.length>0){let M=null;for(;c.untriedMoves.length>0;){const K=Math.floor(Math.random()*c.untriedMoves.length),y=c.untriedMoves.splice(K,1)[0],A=C(p);if(I(A,y[0],y[1],w).valid&&!(E&&k(A)===E)){M=y;break}}if(M){const K=k(p);I(p,M[0],M[1],w),E=K;const y=[];for(let P=0;P<13;P++)for(let B=0;B<13;B++)p[P][B]===0&&y.push([P,B]);const A=new W(M,w,c,y);c.children.push(A),c=A,w=Y(w)}}const d=F(p,w);let v=c;for(;v!==null;)v.visits++,(v.color===1&&d===1||v.color===2&&d===0)&&v.wins++,v=v.parent;f++}let i=null,a=-1;for(const c of l.children)c.visits>a&&(a=c.visits,i=c);const N=Date.now()-u,h=i?(i.wins/i.visits*100).toFixed(1):"0";return console.log(`[MCTS] ${f} iterations in ${N}ms | best: (${i==null?void 0:i.move}) visits=${a} winRate=${h}% | children=${l.children.length}`),(i==null?void 0:i.move)??null}function z(e){const s=Array.from({length:13},()=>new Array(13).fill(0)),n=Array.from({length:13},()=>new Array(13).fill(!1));for(let r=0;r<13;r++)for(let t=0;t<13;t++){if(e[r][t]!==0||n[r][t])continue;const o=[];let l=!1,u=!1;const f=[[r,t]];for(;f.length>0;){const[a,N]=f.pop();if(!n[a][N]){n[a][N]=!0,o.push([a,N]);for(let h=0;h<4;h++){const c=a+g[h],p=N+T[h];m(c,p)&&(e[c][p]===1?l=!0:e[c][p]===2?u=!0:n[c][p]||f.push([c,p]))}}}let i=0;l&&!u?i=1:u&&!l&&(i=2);for(const[a,N]of o)s[a][N]=i}return s}self.onmessage=e=>{const{type:s,board:n,color:r,koHash:t,thinkingTime:o}=e.data;if(s==="findMove"){const l=O(n,r,t,o);postMessage({type:"move",move:l})}s==="score"&&postMessage({type:"score",score:L(n)}),s==="getTerritory"&&postMessage({type:"territory",territory:z(n),score:L(n)})}})();
